<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Nut Safety · Honey & Harvest Scanner</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#fbf7f0;
    --panel:#ffffffcc;
    --accent:#e5b93a; /* warm honey */
    --accent-dark:#b4962b;
    --leaf:#8aa37a;
    --muted:#6b6b6b;
    --glass-blur:8px;
  }

  /* Global */
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
  body{
    background:var(--bg);
    color:#2b2b2b;
    -webkit-font-smoothing:antialiased;
    overflow-x:hidden;
    position:relative;
  }

  /* Subtle honeycomb SVG overlay (soft, elegant) */
  .honey-bg{
    position:fixed;inset:0;z-index:-3;pointer-events:none;
    background:
      radial-gradient(circle at 10% 20%, rgba(229,185,58,0.03) 0%, transparent 25%),
      radial-gradient(circle at 80% 80%, rgba(229,185,58,0.02) 0%, transparent 20%),
      linear-gradient(180deg, transparent 0%, rgba(250,246,238,0.6) 100%);
    mask-image: linear-gradient(180deg, rgba(0,0,0,0.9), rgba(0,0,0,0.65));
  }

  /* honeycomb pattern using SVG as background-image for subtle tiling */
  .honey-bg::after{
    content:"";
    position:absolute;inset:0;
    background-image: url('data:image/svg+xml;utf8,\
      <svg xmlns="http://www.w3.org/2000/svg" width="240" height="210" viewBox="0 0 240 210">\
      <defs>\
        <pattern id="h" width="60" height="70" patternUnits="userSpaceOnUse" patternTransform="rotate(0)">\
          <g fill="none" stroke="%23e9d99f" stroke-opacity="0.08" stroke-width="1">\
            <path d="M30 0 L0 15 L0 45 L30 60 L60 45 L60 15 Z" />\
          </g>\
        </pattern>\
      </defs>\
      <rect width="100%" height="100%" fill="url(%23h)"/></svg>');
    opacity:0.28;
    mix-blend-mode:overlay;
  }

  /* Page container */
  .wrap{
    max-width:980px;
    margin:36px auto;
    padding:24px;
  }

  header{
    display:flex;align-items:center;gap:14px;
    background:linear-gradient(90deg, rgba(229,185,58,0.12), rgba(213,165,48,0.06));
    padding:18px 22px;border-radius:14px;
    box-shadow: 0 6px 20px rgba(51,45,20,0.06);
    border:1px solid rgba(180,150,40,0.06);
  }
  .logo {
    width:56px;height:56px;border-radius:10px;
    background: linear-gradient(180deg,var(--accent),var(--accent-dark));
    display:grid;place-items:center;color:white;font-weight:800;font-size:20px;
    box-shadow: 0 6px 18px rgba(180,140,20,0.18), inset 0 -6px 12px rgba(0,0,0,0.08);
  }
  header h1{margin:0;font-size:20px;letter-spacing:-0.2px;}
  header p{margin:0;font-size:13px;color:var(--muted);}

  /* Main grid */
  .grid{
    display:grid;
    grid-template-columns: 1fr 360px;
    gap:20px;
    margin-top:20px;
  }

  /* Left panel (scanner) */
  .panel{
    background:var(--panel);
    border-radius:14px;
    padding:18px;
    box-shadow: 0 8px 30px rgba(36,30,20,0.06);
    backdrop-filter: blur(var(--glass-blur));
    border:1px solid rgba(255,255,255,0.6);
  }

  .cam-wrap{
    display:flex;flex-direction:column;align-items:center;gap:12px;
  }

  /* webcam card */
  .webcam-card{
    width:100%;
    max-width:560px;
    border-radius:12px;
    padding:10px;
    background: linear-gradient(180deg, rgba(255,255,255,0.55), rgba(255,255,255,0.40));
    display:flex;flex-direction:column;align-items:center;gap:12px;
    border:1px solid rgba(200,160,60,0.08);
    position:relative;
    overflow:hidden;
  }

  /* amber glow behind the webcam (soft) */
  .webcam-glow{
    position:absolute;inset:auto 6% 6% 6%;
    height:60%;border-radius:18px;z-index:-1;
    background: radial-gradient(60% 50% at 50% 60%, rgba(213,165,48,0.22), rgba(213,165,48,0.06));
    filter: blur(18px);
    transform: translateZ(0);
  }

  /* webcam canvas sizing */
  #webcam-container canvas{
    width:100%;
    max-width:520px;
    height:auto;
    border-radius:10px;
    display:block;
    box-shadow: 0 10px 30px rgba(21,18,10,0.08);
  }

  .controls{
    display:flex;gap:12px;align-items:center;justify-content:center;width:100%;
  }
  button.cta{
    background:var(--accent);border:none;padding:10px 14px;border-radius:10px;font-weight:700;color:#2b2b2b;
    box-shadow: 0 6px 14px rgba(180,120,20,0.16);cursor:pointer;
  }
  button.cta:active{transform:translateY(1px)}
  button.secondary{
    background:transparent;border:1px solid rgba(120,120,120,0.08);padding:10px 12px;border-radius:10px;
  }

  /* Label / predictions */
  .labels{
    width:100%;display:flex;flex-direction:column;gap:8px;padding-top:4px;
  }

  .label-row{
    display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,0.7);
    padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.03);
  }

  .label-title{font-weight:600;color:#2b2b2b;}
  .label-prob{font-weight:700;color:#333;}

  /* Confidence honey-bar */
  .honey-bar{
    width:100%;height:18px;border-radius:18px;background:linear-gradient(90deg,#fff2d6,#fff2da);
    border:1px solid rgba(180,150,40,0.06);overflow:hidden;
  }
  .honey-fill{
    height:100%;width:0%;
    background:linear-gradient(90deg,#ffcc46,#d09100);
    border-radius:18px;
    transition: width 420ms cubic-bezier(.2,.9,.2,1);
    box-shadow: inset 0 -6px 12px rgba(0,0,0,0.06);
  }

  /* Right column (info + legend) */
  .side{
    display:flex;flex-direction:column;gap:16px;
  }
  .card{
    background:var(--panel);padding:14px;border-radius:12px;border:1px solid rgba(0,0,0,0.03);
    box-shadow: 0 8px 26px rgba(36,30,20,0.04);
  }
  .card h3{margin:0 0 8px 0;font-size:16px;color:#2b2b2b}
  .muted{color:var(--muted);font-size:14px}

  /* Legend with custom icons (SVG inline look) */
  .legend{display:flex;flex-direction:column;gap:10px}
  .legend-item{display:flex;gap:10px;align-items:center}
  .l-icon{
    width:44px;height:44px;border-radius:10px;display:grid;place-items:center;
    box-shadow: 0 6px 14px rgba(0,0,0,0.06);
    font-weight:700;color:white;
  }
  .l-contains{background:linear-gradient(180deg,#c7620a,#8f3b00)}
  .l-clear{background:linear-gradient(180deg,#5aa86a,#2f7742)}
  .l-maybe{background:linear-gradient(180deg,#e09f2c,#c77d09)}
  .legend-text{font-weight:600}

  /* About & credits */
  .about p{margin:0;color:var(--muted);line-height:1.5}

  /* Footer */
  footer{margin-top:24px;text-align:center;color:var(--muted);font-size:13px;padding-bottom:28px;}
  @media (max-width:900px){
    .grid{grid-template-columns:1fr; padding-bottom:40px;}
    .side{order:2}
  }
</style>
</head>
<body>

<div class="honey-bg" aria-hidden="true"></div>

<div class="wrap">
  <header>
    <div class="logo">H</div>
    <div>
      <h1 style="margin:0">Honey & Harvest — Nut Safety Scanner</h1>
      <p style="margin-top:6px">A warm, honey-themed health-safety tool that classifies snacks for nut risk.</p>
    </div>
  </header>

  <div class="grid">
    <!-- LEFT: Scanner -->
    <section class="panel cam-wrap" aria-labelledby="scanner-title">
      <div style="display:flex;justify-content:space-between;align-items:center;width:100%;">
        <div>
          <h2 id="scanner-title" style="margin:0;font-size:18px">Live Scanner</h2>
          <div style="font-size:13px;color:var(--muted)">Hold the snack up to your webcam and click Start.</div>
        </div>
        <div style="text-align:right;color:var(--muted);font-size:13px">Model: Teachable Machine (3 classes)</div>
      </div>

      <div class="webcam-card" aria-live="polite" role="region" aria-label="Webcam scanner area">
        <div class="webcam-glow" aria-hidden="true"></div>

        <!-- Webcam canvas appended here -->
        <div id="webcam-container" style="width:100%;display:flex;justify-content:center;"></div>

        <div class="controls" style="padding-top:6px;">
          <button class="cta" id="startBtn" onclick="init()">Start Scanner</button>
          <button class="secondary" id="pauseBtn" onclick="togglePlay()" disabled>Pause</button>
          <button class="secondary" id="calibrateBtn" onclick="takeSnapshot()" title="Quick snapshot for training/debug">Snapshot</button>
        </div>

        <!-- Confidence / status -->
        <div style="width:100%;margin-top:10px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div style="font-weight:700">Top prediction</div>
            <div id="topLabel" style="font-weight:800;color:var(--muted)">—</div>
          </div>

          <div class="honey-bar" aria-hidden="true">
            <div id="honeyFill" class="honey-fill" style="width:0%"></div>
          </div>
        </div>

        <!-- Raw labels -->
        <div class="labels" id="label-container" style="width:100%;margin-top:12px"></div>

      </div>
    </section>

    <!-- RIGHT: Info + Legend -->
    <aside class="side">
      <div class="card about" aria-labelledby="about-title">
        <h3 id="about-title">About this project</h3>
        <p>
          This web app uses a Teachable Machine image model trained with at least three classes:
          <strong>Contains Nuts</strong>, <strong>No Nuts</strong>, and <strong>Might Contain</strong>.
          It helps people with nut allergies or caretakers quickly assess packaged snacks. Not a replacement for reading labels.
        </p>
      </div>

      <div class="card" aria-labelledby="legend-title">
        <h3 id="legend-title">Legend</h3>
        <div class="legend">
          <div class="legend-item">
            <div class="l-icon l-contains" aria-hidden="true">
              <!-- nuts SVG -->
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 14c1.6 1.6 3.4 2.4 5 2.4s3.4-.8 5-2.4" stroke="#fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M12 2v8" stroke="#fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M9.5 9.5c.6-1.1 1.3-1.5 2.5-1.5s1.9.4 2.5 1.5" stroke="#fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <div>
              <div class="legend-text">Contains Nuts</div>
              <div class="muted" style="font-size:13px">High risk — avoid if allergic</div>
            </div>
          </div>

          <div class="legend-item">
            <div class="l-icon l-clear" aria-hidden="true">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M20 6L9 17l-5-5" stroke="#fff" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <div>
              <div class="legend-text">No Nuts</div>
              <div class="muted" style="font-size:13px">Low risk — still read label</div>
            </div>
          </div>

          <div class="legend-item">
            <div class="l-icon l-maybe" aria-hidden="true">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2v10" stroke="#fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M12 18h.01" stroke="#fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <div>
              <div class="legend-text">Might Contain</div>
              <div class="muted" style="font-size:13px">Uncertain — check ingredients</div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Tips for better results</h3>
        <ul style="margin:8px 0 0 18px;color:var(--muted)">
          <li>Use good lighting and fill the frame with the snack.</li>
          <li>Avoid motion — hold steady for 1–2 seconds.</li>
          <li>Model improves with more diverse training photos.</li>
        </ul>
      </div>
    </aside>
  </div>

  <footer>Built with Teachable Machine · For classroom projects — not medical advice.</footer>
</div>

<!-- Teachable Machine scripts -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>

<script>
  // Model path (keep your model folder at ./my_model/)
  const URL = "./my_model/";
  let model, webcam, labelContainer, maxPredictions;
  let playing = false;

  // Utility: map likely class names to our categories (robust to small variations)
  function mapClassName(name){
    const lower = name.toLowerCase();
    if(lower.includes('contain') && lower.includes('nut')) return 'Contains Nuts';
    if(lower.includes('no') && lower.includes('nut')) return 'No Nuts';
    if(lower.includes('might') || lower.includes('maybe') || lower.includes('unsure') || lower.includes('possible')) return 'Might Contain';
    // fallback: try keywords
    if(lower.includes('nut')) return 'Contains Nuts';
    if(lower.includes('no')) return 'No Nuts';
    return name; // unknown — use raw label
  }

  // Load model and init webcam
  async function init(){
    if(playing) return;
    try{
      document.getElementById('startBtn').disabled = true;
      const modelURL = URL + "model.json";
      const metadataURL = URL + "metadata.json";
      model = await tmImage.load(modelURL, metadataURL);
      maxPredictions = model.getTotalClasses();

      // setup webcam
      const flip = true;
      webcam = new tmImage.Webcam(480, 360, flip);
      await webcam.setup();
      await webcam.play();
      playing = true;
      document.getElementById('pauseBtn').disabled = false;
      document.getElementById('startBtn').disabled = true;

      // attach canvas
      const container = document.getElementById('webcam-container');
      container.innerHTML = '';
      container.appendChild(webcam.canvas);

      // create label nodes
      labelContainer = document.getElementById('label-container');
      labelContainer.innerHTML = '';
      for(let i=0;i<maxPredictions;i++){
        const row = document.createElement('div');
        row.className = 'label-row';
        row.innerHTML = '<div class="label-title">Label</div><div class="label-prob">0.00</div>';
        labelContainer.appendChild(row);
      }

      // start loop
      window.requestAnimationFrame(loop);

    }catch(err){
      console.error(err);
      alert('Could not load model or webcam. Make sure your model folder exists at ./my_model/ and allow camera access.');
      document.getElementById('startBtn').disabled = false;
    }
  }

  async function loop(){
    if(!playing) return;
    webcam.update();
    await predict();
    window.requestAnimationFrame(loop);
  }

  async function predict(){
    if(!model) return;
    const predictions = await model.predict(webcam.canvas);
    // sort by probability descending (copy)
    const preds = predictions.slice().sort((a,b)=>b.probability-a.probability);

    // Update label list (original order for consistency)
    for(let i=0;i<predictions.length;i++){
      const node = labelContainer.childNodes[i];
      if(!node) continue;
      node.querySelector('.label-title').textContent = predictions[i].className;
      node.querySelector('.label-prob').textContent = (predictions[i].probability).toFixed(2);
    }

    // Top prediction
    const top = preds[0];
    const mapped = mapClassName(top.className);
    const score = Math.round(top.probability * 100);
    document.getElementById('topLabel').textContent = `${mapped} · ${score}%`;

    // Update honey-fill width & color (visual confidence)
    const fill = document.getElementById('honeyFill');
    const width = Math.min(100, Math.max(4, score)); // min visible
    fill.style.width = width + '%';

    // color by category
    let colorStart = '#ffcc46', colorEnd = '#d09100';
    if(mapped === 'Contains Nuts') { colorStart = '#f08b1a'; colorEnd = '#8f3b00'; }
    else if(mapped === 'No Nuts') { colorStart = '#66c28a'; colorEnd = '#2f7742'; }
    else if(mapped === 'Might Contain') { colorStart = '#f0b04a'; colorEnd = '#c77d09'; }
    fill.style.background = `linear-gradient(90deg, ${colorStart}, ${colorEnd})`;

    // subtle webcam glow intensity (based on confidence)
    const glow = document.querySelector('.webcam-glow');
    if(glow){
      const intensity = Math.min(1, top.probability*1.2);
      glow.style.opacity = 0.22 * intensity;
      glow.style.transform = `scale(${1 + intensity*0.03})`;
      glow.style.filter = `blur(${18 - intensity*6}px)`;
    }

    // Accessibility: announce when high-confidence Contains Nuts (optional)
    if(mapped === 'Contains Nuts' && top.probability > 0.86){
      // update aria-live via topLabel (already live region)
    }
  }

  function togglePlay(){
    if(!webcam) return;
    if(playing){
      webcam.pause();
      playing = false;
      document.getElementById('pauseBtn').textContent = 'Resume';
      document.getElementById('startBtn').disabled = false;
    }else{
      webcam.play();
      playing = true;
      window.requestAnimationFrame(loop);
      document.getElementById('pauseBtn').textContent = 'Pause';
      document.getElementById('startBtn').disabled = true;
    }
  }

  function takeSnapshot(){
    if(!webcam) return alert('Start the scanner first.');
    // small snapshot visual feedback
    const data = webcam.canvas.toDataURL('image/png');
    const w = window.open('');
    w.document.write('<img src="'+data+'" style="max-width:90vw">');
  }

  // clean up when leaving
  window.addEventListener('beforeunload', ()=>{
    try{ if(webcam && webcam.stop) webcam.stop(); }catch(e){}
  });
</script>
</body>
</html>
